<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bloxx — Choose a Template</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="editor.css" rel="stylesheet">
  <style>
    html, body { height: auto; overflow: auto; background: var(--bx-bg); }

    .start-header {
      display: flex; align-items: center; gap: 10px;
      padding: 16px 24px; background: var(--bx-surface);
      border-bottom: 1px solid var(--bx-border);
    }
    .start-header .logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px; color: var(--bx-primary); text-decoration: none; }
    .start-header .logo i { font-size: 20px; }
    .start-title { text-align: center; margin: 40px 0 12px; font-size: 22px; font-weight: 700; color: var(--bx-text); }
    .start-subtitle { text-align: center; color: var(--bx-text-muted); margin-bottom: 32px; font-size: 14px; }

    .industry-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 14px; max-width: 900px; margin: 0 auto; padding: 0 24px 60px;
    }
    .industry-card {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 10px; padding: 24px 16px; background: var(--bx-surface);
      border: 1px solid var(--bx-border); border-radius: var(--bx-radius);
      cursor: pointer; transition: border-color .15s, box-shadow .15s;
    }
    .industry-card:hover { border-color: var(--bx-primary); box-shadow: var(--bx-shadow); }
    .industry-card i { font-size: 28px; color: var(--bx-primary); }
    .industry-card span { font-size: 13px; font-weight: 600; color: var(--bx-text); }
    .industry-card .badge-prebuilt { font-size: 10px; font-weight: 600; color: var(--bx-primary); background: color-mix(in srgb, var(--bx-primary) 12%, transparent); padding: 2px 8px; border-radius: 10px; }

    /* Step 2 panel */
    .step2-panel {
      max-width: 540px; margin: 0 auto; padding: 0 24px 60px;
    }
    .step2-back { background: none; border: none; color: var(--bx-text-muted); cursor: pointer; font-size: 13px; margin-bottom: 16px; padding: 0; }
    .step2-back:hover { color: var(--bx-text); }
    .step2-industry-label { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--bx-text); }

    .page-checklist { list-style: none; padding: 0; margin: 0 0 20px; }
    .page-checklist li { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--bx-border); font-size: 13px; }
    .page-checklist li:last-child { border-bottom: none; }
    .page-checklist input[type="checkbox"] { accent-color: var(--bx-primary); }

    .build-btn {
      width: 100%; padding: 12px; border: none; border-radius: var(--bx-radius);
      background: var(--bx-primary); color: #fff; font-weight: 600; font-size: 14px;
      cursor: pointer; transition: background .15s;
    }
    .build-btn:hover { background: var(--bx-primary-hover); }
    .build-btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Add page */
    .add-page-row { display: flex; gap: 8px; margin-top: 8px; }
    .add-page-input { flex: 1; padding: 6px 10px; font-size: 13px; border: 1px solid var(--bx-border); border-radius: var(--bx-radius); background: var(--bx-bg); color: var(--bx-text); }
    .add-page-btn { padding: 6px 12px; font-size: 12px; font-weight: 600; border: 1px solid var(--bx-border); border-radius: var(--bx-radius); background: var(--bx-surface); color: var(--bx-text); cursor: pointer; white-space: nowrap; }
    .add-page-btn:hover { border-color: var(--bx-primary); color: var(--bx-primary); }

    /* Progress */
    @keyframes spin { to { transform: rotate(360deg); } }
    .status-spinner { display: inline-block; animation: spin 1s linear infinite; }
    .progress-panel { max-width: 540px; margin: 0 auto; padding: 0 24px 60px; }
    .progress-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--bx-text); }
    .progress-list { list-style: none; padding: 0; margin: 0; }
    .progress-list li { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--bx-border); font-size: 13px; }
    .progress-list li:last-child { border-bottom: none; }
    .progress-list .status-icon { width: 20px; text-align: center; }
    .progress-list .status-pending { color: var(--bx-text-faint); }
    .progress-list .status-active { color: var(--bx-primary); }
    .progress-list .status-done { color: var(--bx-success); }
    .progress-list .status-error { color: var(--bx-danger); }
    .progress-list .score { margin-left: auto; color: var(--bx-text-muted); font-size: 12px; }

    /* ── Mobile ── */
    @media (max-width: 640px) {
      .start-header { padding: 12px 16px; }
      .start-title { font-size: 18px; margin: 24px 0 8px; }
      .start-subtitle { font-size: 13px; margin-bottom: 20px; }
      .industry-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px; padding: 0 16px 40px;
      }
      .industry-card {
        padding: 16px 10px; gap: 8px;
      }
      .industry-card i { font-size: 24px; }
      .industry-card span { font-size: 12px; }
      .industry-card .badge-prebuilt { font-size: 9px; }
      .step2-panel, .progress-panel { padding: 0 16px 40px; }
      .step2-industry-label { font-size: 16px; }
      .page-checklist li { font-size: 14px; padding: 10px 0; }
      .page-checklist input[type="checkbox"] {
        width: 20px; height: 20px;
      }
      .build-btn { padding: 14px; font-size: 15px; min-height: 48px; }
      .field-input, .field-textarea, input, textarea, select {
        font-size: 16px !important; min-height: 44px; padding: 10px 12px;
      }
      .add-page-row { flex-direction: column; }
      .add-page-input, .add-page-btn { width: 100%; }
      .add-page-btn { padding: 10px; text-align: center; justify-content: center; }
      .progress-list li { font-size: 14px; padding: 12px 0; }
    }
    @media (max-width: 380px) {
      .industry-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px; padding: 0 12px 32px;
      }
      .industry-card { padding: 12px 8px; }
      .industry-card i { font-size: 20px; }
      .industry-card span { font-size: 11px; }
    }
  </style>
</head>
<body>

  <div class="start-header">
    <a class="logo" href="/"><i class="bi bi-grid-3x3-gap-fill"></i><span>Bloxx</span></a>
  </div>

  <!-- Step 1: Industry Grid -->
  <div id="step1">
    <h1 class="start-title">Choose a Template</h1>
    <p class="start-subtitle">Pick your industry and we'll generate a complete website for you.</p>
    <div class="industry-grid" id="industry-grid"></div>
  </div>

  <!-- Step 2: Configure & Build -->
  <div id="step2" hidden>
    <div class="step2-panel">
      <button class="step2-back" id="back-btn"><i class="bi bi-arrow-left"></i> Back to templates</button>
      <div class="step2-industry-label" id="step2-label"></div>

      <div style="margin-bottom: 16px;">
        <label style="font-weight: 600; font-size: 12px; color: var(--bx-text-muted); text-transform: uppercase; letter-spacing: .5px; display: block; margin-bottom: 6px;">Business Name *</label>
        <input type="text" id="business-name" class="field-input" placeholder="e.g. The Bistro" style="width:100%;">
      </div>

      <div style="margin-bottom: 16px;">
        <label style="font-weight: 600; font-size: 12px; color: var(--bx-text-muted); text-transform: uppercase; letter-spacing: .5px; display: block; margin-bottom: 6px;">Brand Context <span style="text-transform:none;font-weight:400">(optional)</span></label>
        <textarea id="brand-context" class="field-input" rows="2" placeholder="e.g. Upscale Italian restaurant in downtown Portland, modern decor" style="width:100%;"></textarea>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="font-weight: 600; font-size: 12px; color: var(--bx-text-muted); text-transform: uppercase; letter-spacing: .5px; display: block; margin-bottom: 8px;">Pages to Generate</label>
        <ul class="page-checklist" id="page-checklist"></ul>
        <div class="add-page-row">
          <input type="text" class="add-page-input" id="add-page-input" placeholder="e.g. Menu, Careers, Gallery...">
          <button type="button" class="add-page-btn" id="add-page-btn"><i class="bi bi-plus"></i> Add Page</button>
        </div>
      </div>

      <button class="build-btn" id="build-btn"><i class="bi bi-stars"></i> Build My Site</button>
    </div>
  </div>

  <!-- Step 3: Progress -->
  <div id="step3" hidden>
    <div class="progress-panel">
      <div class="progress-title" id="progress-title">Building your site...</div>
      <div id="progress-eta" style="font-size: 13px; color: var(--bx-text-muted); margin-bottom: 16px;"></div>
      <ul class="progress-list" id="progress-list"></ul>
    </div>
  </div>

<script>
(function() {
  'use strict';

  const INDUSTRY_TEMPLATES = {
    restaurant:    { label: 'Restaurant',     icon: 'bi-cup-hot',       recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'restaurant', templatePages: ['index', 'about', 'contact', 'faq', 'menu', 'reservations', 'services'] },
    gym:           { label: 'Gym / Fitness',  icon: 'bi-heart-pulse',   recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'], templateSite: 'gym', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'pricing'] },
    yoga:          { label: 'Yoga Studio',    icon: 'bi-flower1',       recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'], templateSite: 'yoga', templatePages: ['index', 'about', 'contact', 'services'] },
    lawfirm:       { label: 'Law Firm',       icon: 'bi-briefcase',     recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'lawfirm', templatePages: ['index', 'about', 'contact', 'services'] },
    accountant:    { label: 'Accountant',     icon: 'bi-calculator',    recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'accountant', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'faq'] },
    realestate:    { label: 'Real Estate',    icon: 'bi-house-door',    recommended: ['Homepage', 'About', 'Services', 'Contact'], templateSite: 'realestate', templatePages: ['index', 'about', 'services', 'contact', 'blog'] },
    salon:         { label: 'Salon / Spa',    icon: 'bi-scissors',      recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'], templateSite: 'salon', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'pricing'] },
    dentist:       { label: 'Dentist',        icon: 'bi-emoji-smile',   recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'dentist', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'faq'] },
    saas:          { label: 'SaaS / Tech',    icon: 'bi-laptop',        recommended: ['Homepage', 'About', 'Pricing', 'Contact', 'FAQ', 'BlogIndex'], templateSite: 'saas', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'pricing', 'faq', 'blog-index'] },
    agency:        { label: 'Agency',         icon: 'bi-palette',       recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'], templateSite: 'agency', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'pricing'] },
    ecommerce:     { label: 'E-commerce',     icon: 'bi-bag',           recommended: ['Homepage', 'Product', 'Pricing', 'Contact', 'FAQ'], templateSite: 'ecommerce', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'product', 'faq'] },
    coffeeshop:    { label: 'Coffee Shop',    icon: 'bi-cup',           recommended: ['Homepage', 'About', 'Contact'], templateSite: 'coffeeshop', templatePages: ['index', 'about', 'services', 'contact', 'blog'] },
    photography:   { label: 'Photography',    icon: 'bi-camera',        recommended: ['Homepage', 'About', 'Services', 'Contact'], templateSite: 'photography', templatePages: ['index', 'about', 'services', 'contact', 'blog'] },
    construction:  { label: 'Construction',   icon: 'bi-tools',         recommended: ['Homepage', 'About', 'Services', 'Contact'], templateSite: 'construction', templatePages: ['index', 'about', 'services', 'contact', 'blog'] },
    plumber:       { label: 'Plumber',        icon: 'bi-wrench',        recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'plumber', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'faq'] },
    insurance:     { label: 'Insurance',      icon: 'bi-shield-check',  recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'insurance', templatePages: ['index', 'about', 'services', 'contact', 'blog', 'faq'] },
  };

  // Page template key → slug mapping
  const PAGE_SLUGS = {
    Homepage: 'index', About: 'about', Services: 'services', Contact: 'contact',
    FAQ: 'faq', Pricing: 'pricing', BlogIndex: 'blog', BlogPost: 'blog-post',
    Product: 'product', LandingPage: 'landing', Privacy: 'privacy', Terms: 'terms',
  };

  // All available pages for the checklist (superset)
  const ALL_PAGES = ['Homepage', 'About', 'Services', 'Contact', 'FAQ', 'Pricing', 'BlogIndex', 'Product'];

  // Reverse mapping: slug → template key
  const SLUG_TO_PAGE = {};
  for (const [k, v] of Object.entries(PAGE_SLUGS)) SLUG_TO_PAGE[v] = k;
  // Extra slug-only pages (no template key, shown as-is)
  const EXTRA_SLUG_LABELS = { menu: 'Menu', reservations: 'Reservations' };

  let selectedIndustry = null;

  // Render industry grid
  const grid = document.getElementById('industry-grid');
  for (const [key, tmpl] of Object.entries(INDUSTRY_TEMPLATES)) {
    const card = document.createElement('div');
    card.className = 'industry-card';
    const badge = tmpl.templateSite ? '<span class="badge-prebuilt">Pre-built</span>' : '';
    card.innerHTML = `<i class="bi ${tmpl.icon}"></i><span>${tmpl.label}</span>${badge}`;
    card.addEventListener('click', () => selectIndustry(key, tmpl));
    grid.appendChild(card);
  }

  function selectIndustry(key, tmpl) {
    selectedIndustry = key;
    document.getElementById('step1').hidden = true;
    document.getElementById('step2').hidden = false;
    document.getElementById('step2-label').textContent = tmpl.label + ' Website';

    const checklist = document.getElementById('page-checklist');
    checklist.innerHTML = '';

    if (tmpl.templateSite && tmpl.templatePages) {
      // Template industry: show pre-built pages first (checked), then remaining standard pages (unchecked)
      const templateSlugs = new Set(tmpl.templatePages);
      const shownKeys = new Set();

      // Pre-built template pages first
      for (const slug of tmpl.templatePages) {
        const pageKey = SLUG_TO_PAGE[slug] || slug;
        const label = EXTRA_SLUG_LABELS[slug] || (pageKey === 'BlogIndex' ? 'Blog Index' : pageKey.charAt(0).toUpperCase() + pageKey.slice(1));
        const li = document.createElement('li');
        const id = 'page-' + pageKey;
        li.innerHTML = `<input type="checkbox" id="${id}" value="${pageKey}" checked><label for="${id}">${label} <span style="font-size:10px;color:var(--bx-primary);opacity:.7">instant</span></label>`;
        checklist.appendChild(li);
        shownKeys.add(pageKey);
      }

      // Remaining standard pages (AI-generated)
      for (const page of ALL_PAGES) {
        if (shownKeys.has(page)) continue;
        const li = document.createElement('li');
        const id = 'page-' + page;
        li.innerHTML = `<input type="checkbox" id="${id}" value="${page}"><label for="${id}">${page === 'BlogIndex' ? 'Blog Index' : page} <span style="font-size:10px;color:var(--bx-text-muted);opacity:.7">AI</span></label>`;
        checklist.appendChild(li);
      }
    } else {
      // AI industry: show full page list
      for (const page of ALL_PAGES) {
        const li = document.createElement('li');
        const id = 'page-' + page;
        const checked = tmpl.recommended.includes(page) ? 'checked' : '';
        li.innerHTML = `<input type="checkbox" id="${id}" value="${page}" ${checked}><label for="${id}">${page === 'BlogIndex' ? 'Blog Index' : page}</label>`;
        checklist.appendChild(li);
      }
    }

    document.getElementById('business-name').value = '';
    document.getElementById('brand-context').value = '';
    document.getElementById('business-name').focus();
  }

  document.getElementById('back-btn').addEventListener('click', () => {
    document.getElementById('step2').hidden = true;
    document.getElementById('step1').hidden = false;
  });

  // ─── Add custom page ───
  let customPageCounter = 0;
  document.getElementById('add-page-btn').addEventListener('click', () => {
    const input = document.getElementById('add-page-input');
    const name = input.value.trim();
    if (!name) return;
    input.value = '';
    customPageCounter++;
    const pageKey = 'Custom_' + customPageCounter + '_' + name.replace(/[^a-zA-Z0-9]/g, '');
    const checklist = document.getElementById('page-checklist');
    const li = document.createElement('li');
    const id = 'page-' + pageKey;
    li.innerHTML = `<input type="checkbox" id="${id}" value="${pageKey}" data-custom-name="${name}" checked><label for="${id}">${name} <span style="font-size:10px;color:var(--bx-text-muted);opacity:.7">AI</span></label>`;
    checklist.appendChild(li);
  });
  document.getElementById('add-page-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); document.getElementById('add-page-btn').click(); }
  });

  // ─── Build: per-page requests with live progress ───
  document.getElementById('build-btn').addEventListener('click', async () => {
    const businessName = document.getElementById('business-name').value.trim();
    if (!businessName) { alert('Please enter a business name.'); return; }

    const checkboxes = [...document.querySelectorAll('#page-checklist input:checked')];
    if (checkboxes.length === 0) { alert('Select at least one page.'); return; }

    const brandContext = document.getElementById('brand-context').value.trim();
    const industryConf = INDUSTRY_TEMPLATES[selectedIndustry];

    // Build page list with metadata
    const pageList = checkboxes.map(cb => ({
      key: cb.value,
      customName: cb.dataset.customName || null,
      label: cb.dataset.customName || (cb.value === 'BlogIndex' ? 'Blog Index' : cb.value),
    }));

    // Show progress
    document.getElementById('step2').hidden = true;
    document.getElementById('step3').hidden = false;
    document.getElementById('progress-title').textContent = 'Building ' + businessName + '...';

    const progressList = document.getElementById('progress-list');
    progressList.innerHTML = '';
    for (const p of pageList) {
      const li = document.createElement('li');
      li.id = 'progress-' + p.key;
      li.innerHTML = `<span class="status-icon status-pending"><i class="bi bi-circle"></i></span><span>${p.label}</span><span class="score"></span>`;
      progressList.appendChild(li);
    }

    let site = null;
    let doneCount = 0;
    let errorCount = 0;

    // Concurrent page generation with ETA
    const CONCURRENCY = 3;
    const startTime = Date.now();

    function updateProgress() {
      const finished = doneCount + errorCount;
      document.getElementById('progress-title').textContent =
        `Building ${businessName}... (${finished}/${pageList.length})`;

      if (finished > 0 && finished < pageList.length) {
        const elapsed = Date.now() - startTime;
        const avgMs = elapsed / finished;
        const remaining = pageList.length - finished;
        const parallelFactor = Math.min(CONCURRENCY, remaining);
        const etaSec = Math.ceil((avgMs * remaining) / 1000 / parallelFactor);
        const min = Math.floor(etaSec / 60);
        const sec = etaSec % 60;
        document.getElementById('progress-eta').textContent =
          min > 0 ? `~${min}m ${sec}s remaining` : `~${sec}s remaining`;
      } else {
        document.getElementById('progress-eta').textContent = '';
      }
    }

    function setLiStatus(li, status, text) {
      if (!li) return;
      const icon = li.querySelector('.status-icon');
      const score = li.querySelector('.score');
      if (icon) {
        icon.className = 'status-icon ' + status;
        const icons = { 'status-pending': 'bi-circle', 'status-active': 'bi-arrow-repeat status-spinner', 'status-done': 'bi-check-circle-fill', 'status-error': 'bi-x-circle-fill' };
        icon.innerHTML = '<i class="bi ' + (icons[status] || 'bi-circle') + '"></i>';
      }
      if (score && text !== undefined) {
        score.textContent = (text || '').length > 60 ? text.substring(0, 57) + '...' : (text || '');
      }
    }

    async function processPage(p) {
      const li = document.getElementById('progress-' + p.key);
      setLiStatus(li, 'status-active', industryConf.templateSite ? '' : 'generating...');

      try {
        const res = await fetch('/api/site-create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            industry: selectedIndustry,
            businessName,
            brandContext: brandContext || undefined,
            pages: [p.customName || p.key],
          }),
        });
        const data = await res.json();

        if (!site && data.site) site = data.site;

        if (data.ok && data.pages && data.pages.length > 0) {
          const score = data.pages[0].score;
          setLiStatus(li, 'status-done', score && score < 100 ? 'Score: ' + score : '');
          doneCount++;
        } else {
          const errMsg = (data.errors && data.errors[0]?.error) || data.error || 'Failed';
          setLiStatus(li, 'status-error', errMsg);
          errorCount++;
        }
      } catch (err) {
        setLiStatus(li, 'status-error', err.message);
        errorCount++;
      }
      updateProgress();
    }

    // Async pool: run up to CONCURRENCY pages at once
    async function runPool(items, concurrency, fn) {
      const executing = new Set();
      for (const item of items) {
        const promise = fn(item).finally(() => executing.delete(promise));
        executing.add(promise);
        if (executing.size >= concurrency) {
          await Promise.race(executing);
        }
      }
      await Promise.all(executing);
    }

    await runPool(pageList, CONCURRENCY, processPage);

    // Done
    if (site && doneCount > 0) {
      document.getElementById('progress-title').textContent = 'Site created! Redirecting to editor...';
      setTimeout(() => {
        window.location.href = '/?site=' + encodeURIComponent(site) + '&page=index';
      }, 1500);
    } else {
      document.getElementById('progress-title').textContent = 'Build failed — see errors above.';
    }
  });
})();
</script>
</body>
</html>
