<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bloxx — Choose a Template</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="editor.css" rel="stylesheet">
  <style>
    html, body { height: auto; overflow: auto; background: var(--bx-bg); }

    .start-header {
      display: flex; align-items: center; gap: 10px;
      padding: 16px 24px; background: var(--bx-surface);
      border-bottom: 1px solid var(--bx-border);
    }
    .start-header .logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px; color: var(--bx-primary); text-decoration: none; }
    .start-header .logo i { font-size: 20px; }
    .start-title { text-align: center; margin: 40px 0 12px; font-size: 22px; font-weight: 700; color: var(--bx-text); }
    .start-subtitle { text-align: center; color: var(--bx-text-muted); margin-bottom: 32px; font-size: 14px; }

    .industry-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 14px; max-width: 900px; margin: 0 auto; padding: 0 24px 60px;
    }
    .industry-card {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 10px; padding: 24px 16px; background: var(--bx-surface);
      border: 1px solid var(--bx-border); border-radius: var(--bx-radius);
      cursor: pointer; transition: border-color .15s, box-shadow .15s;
    }
    .industry-card:hover { border-color: var(--bx-primary); box-shadow: var(--bx-shadow); }
    .industry-card i { font-size: 28px; color: var(--bx-primary); }
    .industry-card span { font-size: 13px; font-weight: 600; color: var(--bx-text); }
    .industry-card .badge-prebuilt { font-size: 10px; font-weight: 600; color: var(--bx-primary); background: color-mix(in srgb, var(--bx-primary) 12%, transparent); padding: 2px 8px; border-radius: 10px; }

    /* Step 2 panel */
    .step2-panel {
      max-width: 540px; margin: 0 auto; padding: 0 24px 60px;
    }
    .step2-back { background: none; border: none; color: var(--bx-text-muted); cursor: pointer; font-size: 13px; margin-bottom: 16px; padding: 0; }
    .step2-back:hover { color: var(--bx-text); }
    .step2-industry-label { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--bx-text); }

    .page-checklist { list-style: none; padding: 0; margin: 0 0 20px; }
    .page-checklist li { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--bx-border); font-size: 13px; }
    .page-checklist li:last-child { border-bottom: none; }
    .page-checklist input[type="checkbox"] { accent-color: var(--bx-primary); }

    .build-btn {
      width: 100%; padding: 12px; border: none; border-radius: var(--bx-radius);
      background: var(--bx-primary); color: #fff; font-weight: 600; font-size: 14px;
      cursor: pointer; transition: background .15s;
    }
    .build-btn:hover { background: var(--bx-primary-hover); }
    .build-btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Progress */
    .progress-panel { max-width: 540px; margin: 0 auto; padding: 0 24px 60px; }
    .progress-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--bx-text); }
    .progress-list { list-style: none; padding: 0; margin: 0; }
    .progress-list li { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--bx-border); font-size: 13px; }
    .progress-list li:last-child { border-bottom: none; }
    .progress-list .status-icon { width: 20px; text-align: center; }
    .progress-list .status-pending { color: var(--bx-text-faint); }
    .progress-list .status-active { color: var(--bx-primary); }
    .progress-list .status-done { color: var(--bx-success); }
    .progress-list .status-error { color: var(--bx-danger); }
    .progress-list .score { margin-left: auto; color: var(--bx-text-muted); font-size: 12px; }
  </style>
</head>
<body>

  <div class="start-header">
    <a class="logo" href="/"><i class="bi bi-grid-3x3-gap-fill"></i><span>Bloxx</span></a>
  </div>

  <!-- Step 1: Industry Grid -->
  <div id="step1">
    <h1 class="start-title">Choose a Template</h1>
    <p class="start-subtitle">Pick your industry and we'll generate a complete website for you.</p>
    <div class="industry-grid" id="industry-grid"></div>
  </div>

  <!-- Step 2: Configure & Build -->
  <div id="step2" hidden>
    <div class="step2-panel">
      <button class="step2-back" id="back-btn"><i class="bi bi-arrow-left"></i> Back to templates</button>
      <div class="step2-industry-label" id="step2-label"></div>

      <div style="margin-bottom: 16px;">
        <label style="font-weight: 600; font-size: 12px; color: var(--bx-text-muted); text-transform: uppercase; letter-spacing: .5px; display: block; margin-bottom: 6px;">Business Name *</label>
        <input type="text" id="business-name" class="field-input" placeholder="e.g. The Bistro" style="width:100%;">
      </div>

      <div style="margin-bottom: 16px;">
        <label style="font-weight: 600; font-size: 12px; color: var(--bx-text-muted); text-transform: uppercase; letter-spacing: .5px; display: block; margin-bottom: 6px;">Brand Context <span style="text-transform:none;font-weight:400">(optional)</span></label>
        <textarea id="brand-context" class="field-input" rows="2" placeholder="e.g. Upscale Italian restaurant in downtown Portland, modern decor" style="width:100%;"></textarea>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="font-weight: 600; font-size: 12px; color: var(--bx-text-muted); text-transform: uppercase; letter-spacing: .5px; display: block; margin-bottom: 8px;">Pages to Generate</label>
        <ul class="page-checklist" id="page-checklist"></ul>
      </div>

      <button class="build-btn" id="build-btn"><i class="bi bi-stars"></i> Build My Site</button>
    </div>
  </div>

  <!-- Step 3: Progress -->
  <div id="step3" hidden>
    <div class="progress-panel">
      <div class="progress-title" id="progress-title">Building your site...</div>
      <ul class="progress-list" id="progress-list"></ul>
    </div>
  </div>

<script>
(function() {
  'use strict';

  const INDUSTRY_TEMPLATES = {
    restaurant:    { label: 'Restaurant',     icon: 'bi-cup-hot',       recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'restaurant', templatePages: ['index', 'about', 'contact', 'faq', 'menu', 'reservations', 'services'] },
    gym:           { label: 'Gym / Fitness',  icon: 'bi-heart-pulse',   recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'] },
    yoga:          { label: 'Yoga Studio',    icon: 'bi-flower1',       recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'], templateSite: 'yoga', templatePages: ['index', 'about', 'contact', 'services'] },
    lawfirm:       { label: 'Law Firm',       icon: 'bi-briefcase',     recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'], templateSite: 'lawfirm', templatePages: ['index', 'about', 'contact', 'services'] },
    accountant:    { label: 'Accountant',     icon: 'bi-calculator',    recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'] },
    realestate:    { label: 'Real Estate',    icon: 'bi-house-door',    recommended: ['Homepage', 'About', 'Services', 'Contact'] },
    salon:         { label: 'Salon / Spa',    icon: 'bi-scissors',      recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'] },
    dentist:       { label: 'Dentist',        icon: 'bi-emoji-smile',   recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'] },
    saas:          { label: 'SaaS / Tech',    icon: 'bi-laptop',        recommended: ['Homepage', 'About', 'Pricing', 'Contact', 'FAQ', 'BlogIndex'] },
    agency:        { label: 'Agency',         icon: 'bi-palette',       recommended: ['Homepage', 'About', 'Services', 'Pricing', 'Contact'] },
    ecommerce:     { label: 'E-commerce',     icon: 'bi-bag',           recommended: ['Homepage', 'Product', 'Pricing', 'Contact', 'FAQ'] },
    coffeeshop:    { label: 'Coffee Shop',    icon: 'bi-cup',           recommended: ['Homepage', 'About', 'Contact'] },
    photography:   { label: 'Photography',    icon: 'bi-camera',        recommended: ['Homepage', 'About', 'Services', 'Contact'] },
    construction:  { label: 'Construction',   icon: 'bi-tools',         recommended: ['Homepage', 'About', 'Services', 'Contact'] },
    plumber:       { label: 'Plumber',        icon: 'bi-wrench',        recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'] },
    insurance:     { label: 'Insurance',      icon: 'bi-shield-check',  recommended: ['Homepage', 'About', 'Services', 'Contact', 'FAQ'] },
  };

  // Page template key → slug mapping
  const PAGE_SLUGS = {
    Homepage: 'index', About: 'about', Services: 'services', Contact: 'contact',
    FAQ: 'faq', Pricing: 'pricing', BlogIndex: 'blog', BlogPost: 'blog-post',
    Product: 'product', LandingPage: 'landing', Privacy: 'privacy', Terms: 'terms',
  };

  // All available pages for the checklist (superset)
  const ALL_PAGES = ['Homepage', 'About', 'Services', 'Contact', 'FAQ', 'Pricing', 'BlogIndex', 'Product'];

  // Reverse mapping: slug → template key
  const SLUG_TO_PAGE = {};
  for (const [k, v] of Object.entries(PAGE_SLUGS)) SLUG_TO_PAGE[v] = k;
  // Extra slug-only pages (no template key, shown as-is)
  const EXTRA_SLUG_LABELS = { menu: 'Menu', reservations: 'Reservations' };

  let selectedIndustry = null;

  // Render industry grid
  const grid = document.getElementById('industry-grid');
  for (const [key, tmpl] of Object.entries(INDUSTRY_TEMPLATES)) {
    const card = document.createElement('div');
    card.className = 'industry-card';
    const badge = tmpl.templateSite ? '<span class="badge-prebuilt">Pre-built</span>' : '';
    card.innerHTML = `<i class="bi ${tmpl.icon}"></i><span>${tmpl.label}</span>${badge}`;
    card.addEventListener('click', () => selectIndustry(key, tmpl));
    grid.appendChild(card);
  }

  function selectIndustry(key, tmpl) {
    selectedIndustry = key;
    document.getElementById('step1').hidden = true;
    document.getElementById('step2').hidden = false;
    document.getElementById('step2-label').textContent = tmpl.label + ' Website';

    const checklist = document.getElementById('page-checklist');
    checklist.innerHTML = '';

    if (tmpl.templateSite && tmpl.templatePages) {
      // Template industry: show pre-built pages first (checked), then remaining standard pages (unchecked)
      const templateSlugs = new Set(tmpl.templatePages);
      const shownKeys = new Set();

      // Pre-built template pages first
      for (const slug of tmpl.templatePages) {
        const pageKey = SLUG_TO_PAGE[slug] || slug;
        const label = EXTRA_SLUG_LABELS[slug] || (pageKey === 'BlogIndex' ? 'Blog Index' : pageKey.charAt(0).toUpperCase() + pageKey.slice(1));
        const li = document.createElement('li');
        const id = 'page-' + pageKey;
        li.innerHTML = `<input type="checkbox" id="${id}" value="${pageKey}" checked><label for="${id}">${label} <span style="font-size:10px;color:var(--bx-primary);opacity:.7">instant</span></label>`;
        checklist.appendChild(li);
        shownKeys.add(pageKey);
      }

      // Remaining standard pages (AI-generated)
      for (const page of ALL_PAGES) {
        if (shownKeys.has(page)) continue;
        const li = document.createElement('li');
        const id = 'page-' + page;
        li.innerHTML = `<input type="checkbox" id="${id}" value="${page}"><label for="${id}">${page === 'BlogIndex' ? 'Blog Index' : page} <span style="font-size:10px;color:var(--bx-text-muted);opacity:.7">AI</span></label>`;
        checklist.appendChild(li);
      }
    } else {
      // AI industry: show full page list
      for (const page of ALL_PAGES) {
        const li = document.createElement('li');
        const id = 'page-' + page;
        const checked = tmpl.recommended.includes(page) ? 'checked' : '';
        li.innerHTML = `<input type="checkbox" id="${id}" value="${page}" ${checked}><label for="${id}">${page === 'BlogIndex' ? 'Blog Index' : page}</label>`;
        checklist.appendChild(li);
      }
    }

    document.getElementById('business-name').value = '';
    document.getElementById('brand-context').value = '';
    document.getElementById('business-name').focus();
  }

  document.getElementById('back-btn').addEventListener('click', () => {
    document.getElementById('step2').hidden = true;
    document.getElementById('step1').hidden = false;
  });

  document.getElementById('build-btn').addEventListener('click', async () => {
    const businessName = document.getElementById('business-name').value.trim();
    if (!businessName) { alert('Please enter a business name.'); return; }

    const checked = [...document.querySelectorAll('#page-checklist input:checked')].map(cb => cb.value);
    if (checked.length === 0) { alert('Select at least one page.'); return; }

    const brandContext = document.getElementById('brand-context').value.trim();

    // Show progress
    document.getElementById('step2').hidden = true;
    document.getElementById('step3').hidden = false;
    const isTemplate = !!(INDUSTRY_TEMPLATES[selectedIndustry].templateSite);
    document.getElementById('progress-title').textContent = isTemplate
      ? 'Copying templates for ' + businessName + '...'
      : 'Building ' + businessName + '...';

    const progressList = document.getElementById('progress-list');
    progressList.innerHTML = '';
    for (const page of checked) {
      const li = document.createElement('li');
      li.id = 'progress-' + page;
      li.innerHTML = `<span class="status-icon status-pending"><i class="bi bi-circle"></i></span><span>${page === 'BlogIndex' ? 'Blog Index' : page}</span><span class="score"></span>`;
      progressList.appendChild(li);
    }

    // Call site-create endpoint
    try {
      const res = await fetch('/api/site-create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          industry: selectedIndustry,
          businessName,
          brandContext: brandContext || undefined,
          pages: checked,
        }),
      });
      const data = await res.json();

      if (data.ok) {
        // Update progress with results
        for (const p of data.pages || []) {
          const li = document.getElementById('progress-' + p.pageName);
          if (li) {
            li.querySelector('.status-icon').className = 'status-icon status-done';
            li.querySelector('.status-icon').innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            li.querySelector('.score').textContent = p.score ? 'Score: ' + p.score : '';
          }
        }
        for (const e of data.errors || []) {
          const li = document.getElementById('progress-' + e.pageName);
          if (li) {
            li.querySelector('.status-icon').className = 'status-icon status-error';
            li.querySelector('.status-icon').innerHTML = '<i class="bi bi-x-circle-fill"></i>';
            li.querySelector('.score').textContent = e.error;
          }
        }

        // Redirect to editor after short delay
        document.getElementById('progress-title').textContent = 'Site created! Redirecting to editor...';
        setTimeout(() => {
          window.location.href = '/?site=' + encodeURIComponent(data.site) + '&page=index';
        }, 1500);
      } else {
        document.getElementById('progress-title').textContent = 'Error: ' + (data.error || 'Unknown error');
      }
    } catch (err) {
      document.getElementById('progress-title').textContent = 'Error: ' + err.message;
    }
  });
})();
</script>
</body>
</html>
